<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Source: ui/dialog/index.js - Alien documents</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <script src="scripts/jquery.1.10.min.js"> </script>
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="css/style.css">
</head>

<body>


<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">Alien documents</a>
    </div>
    <nav role="navigation">
		<ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
<ul class="dropdown-menu">
<li><a href="index_.html">/index</a></li>
<li><a href="jsonp.html">core/communication/jsonp</a></li>
<li><a href="xhr.html">core/communication/xhr</a></li>
<li><a href="animation.html">core/dom/animation</a></li>
<li><a href="attribute.html">core/dom/attribute</a></li>
<li><a href="modification.html">core/dom/modification</a></li>
<li><a href="selector.html">core/dom/selector</a></li>
<li><a href="base.html">core/event/base</a></li>
<li><a href="ready.html">core/event/ready</a></li>
<li><a href="touch.html">core/event/touch</a></li>
<li><a href="wheel.html">core/event/wheel</a></li>
<li><a href="compatible.html">core/navigator/compatible</a></li>
<li><a href="hashbang.html">core/navigator/hashbang</a></li>
<li><a href="querystring.html">core/navigator/querystring</a></li>
<li><a href="shell.html">core/navigator/shell</a></li>
<li><a href="ua.html">core/navigator/ua</a></li>
<li><a href="drag.html">parent/drag</a></li>
<li><a href="Template.html">parent/Template</a></li>
<li><a href="upload.html">parent/upload</a></li>
<li><a href="index__.html">ui/banner/index</a></li>
<li><a href="style.html">ui/banner/style</a></li>
<li><a href="index___.html">ui/dialog/index</a></li>
<li><a href="style_.html">ui/dialog/style</a></li>
<li><a href="Drag_.html">ui/Drag</a></li>
<li><a href="index____.html">ui/drag/index</a></li>
<li><a href="style__.html">ui/drag/style</a></li>
<li><a href="index_____.html">ui/msg/index</a></li>
<li><a href="style___.html">ui/msg/style</a></li>
<li><a href="index______.html">ui/scrollbar/index</a></li>
<li><a href="style____.html">ui/scrollbar/style</a></li>
<li><a href="class.html">util/class</a></li>
<li><a href="data.html">util/data</a></li>
<li><a href="date.html">util/date</a></li>
<li><a href="Deferred.html">util/Deferred</a></li>
<li><a href="easing.html">util/easing</a></li>
<li><a href="Emitter.html">util/Emitter</a></li>
<li><a href="Pagination.html">util/Pagination</a></li>
<li><a href="Validate.html">util/Validate</a></li>
</ul>
</li>
</ul>
    </nav>
  </div>
</div>


<div id="main">


	

	    <div class="main">
	        <nav id="docs-sidebar">
	            

	            <ul class="nav sidebar-list">
	                

	                

	                

	                
	            </ul>
	        </nav>

	        <section id="docs-content">
	            <div class="content">
		            <h1 class="page-title">Source: ui/dialog/index.js</h1>

		            


    

<pre class="prettyprint source"><code>define(function (require, exports, module) {
    /**
     * @module ui/dialog/index
     * @requires ui/dialog/style
     * @requires ui/drag/index
     * @requires util/class
     * @requires util/data
     * @requires core/dom/modification
     * @requires core/dom/selector
     * @requires core/dom/attribute
     * @requires core/dom/animation
     * @requires core/event/touch
     * @author ydr.me
     * @create 2014-10-04 02:33
     */

    'use strict';

    require('./style.js');

    var klass = require('../../util/class.js');
    var drag = require('../drag/index.js');
    var modification = require('../../core/dom/modification.js');
    var selector = require('../../core/dom/selector.js');
    var attribute = require('../../core/dom/attribute.js');
    var animation = require('../../core/dom/animation.js');
    var event = require('../../core/event/touch.js');
    var data = require('../../util/data.js');
    var index = 0;
    var zIndex = 9999;
//    var html = document.documentElement;
    var body = document.body;
    var overflowClass = 'alien-ui-dialog-overflow';
    var dialogClass = 'alien-ui-dialog';
    var bodyClass = 'alien-ui-dialog-body';
    var titleClass = 'alien-ui-dialog-title';
    var closeClass = 'alien-ui-dialog-close';
    var iframeClass = 'alien-ui-dialog-iframe';
    var shakeClass = 'alien-ui-dialog-shake';
    var noop = function () {
        // ignore
    };
    var defaults = {
        width: 500,
        height: 'auto',
        left: 'center',
        top: 'center',
        title: '无标题对话框',
        canDrag: !0,
        duration: 345,
        easing: 'ease-in-out-back',
        // 优先级2
        remote: null,
        remoteHeight: 400,
        // 优先级1
        content: null,
        // 优先级1
        isWrap: !0,
        onopen: noop,
        onclose: noop
    };
    // 打开的对话框队列
    var openDialogs = [];
    var dialogsMap = {};
    var Dialog = klass.create({
        STATIC: {
            defaults: defaults
        },

        constructor: function (ele, options) {
            this.ele = ele;
            this.options = options;
        },


        /**
         * 初始化
         * @returns {Dialog}
         * @private
         */
        _init: function () {
            index++;

            var the = this;
            var options = the.options;
            var bg = modification.create('div', {
                id: 'alien-ui-dialog-bg-' + index,
                'class': 'alien-ui-dialog-bg'
            });
            var dialog = modification.create('div', {
                id: 'alien-ui-dialog-' + index,
                'class': dialogClass,
                role: 'dialog'
            });
            var bd;

            if (options.isWrap) {
                dialog.innerHTML = '&lt;div class="alien-ui-dialog-container">' +
                    (options.title === null ? '' :
                        '&lt;div class="alien-ui-dialog-header">' +
                        '&lt;div class="' + titleClass + '">' + options.title + '&lt;/div>' +
                        '&lt;div class="' + closeClass + '">&amp;times;&lt;/div>' +
                        '&lt;/div>') +
                    '&lt;div class="' + bodyClass + '">&lt;/div>' +
                    '&lt;/div>';
                bd = selector.query('.' + bodyClass, dialog)[0];
            }

            modification.insert(bg, body, 'beforeend');
            modification.insert(dialog, bg, 'beforeend');
            the.bg = bg;

            the.dialog = dialog;
            the.hasOpen = !1;
            the.zIndex = 0;
            the.id = index;
            dialogsMap[the.id] = the;

            if (options.title !== null &amp;&amp; options.canDrag &amp;&amp; options.isWrap) {
                drag(dialog, {
                    handle: '.' + titleClass,
                    zIndex: the.zIndex
                });
            }

            modification.insert(the.ele, bd ? bd : dialog, 'beforeend');

            event.on(dialog, 'click tap', '.' + closeClass, function () {
                the.close();
            });

            event.on(the.bg, 'click tap', function (eve) {
                eve.stopPropagation();

                if (!selector.closest(eve.target, '.' + dialogClass).length) {
                    the.shake();
                }
            });

            return the;
        },


        /**
         * 打开对话框
         * @param {Function} [callback] 打开之后回调
         * @returns {Dialog}
         */
        open: function (callback) {
            callback = callback || noop;

//            var winW = attribute.width(window);
//            var winH = attribute.height(window);
            var the = this;
            var bg = the.bg;
            var dialog = the.dialog;
            var to;
            var options = the.options;
            var findIndex;

            if (the.hasOpen) {
                return the;
            }

            the.hasOpen = !0;
            findIndex = openDialogs.indexOf(the.id);

            if (findIndex > -1) {
                openDialogs.splice(findIndex, 1);
            }

            openDialogs.push(the.id);
            attribute.addClass(body, overflowClass);

            if (options.content || options.remote) {
                the.ele.innerHTML = '';
            }

            attribute.css(bg, {
                display: 'block',
                zIndex: ++zIndex,
                opacity: 0
            });

            attribute.css(dialog, {
                display: 'block',
                visibility: 'hidden',
                width: options.width,
                height: options.height
            });

            the.zIndex = zIndex;
            to = the._position();
            to.opacity = '';
            to.transform = 'scale(1)';

            attribute.css(dialog, {
                opacity: 0,
                visibility: 'visible',
                left: to.left,
                top: to.top,
                transform: 'scale(0)'
            });

            animation.animate(bg, {
                opacity: 1
            }, {
                duration: options.duration,
                easing: options.easing
            });

            animation.animate(dialog, to, {
                duration: options.duration,
                easing: options.easing
            }, function () {
                options.onopen.call(dialog);

                if (!options.content &amp;&amp; options.remote) {
                    the.setRemote(options.remote);
                }

                if (data.type(callback) === 'function') {
                    callback.call(the);
                }
            });

            if (options.content) {
                the.setContent(options.content);
            }

            return the;
        },


        /**
         * 关闭对话框
         * @param {Function} [callback] 打开之后回调
         * @returns {Dialog}
         */
        close: function (callback) {
            var the = this;
            var bg = the.bg;
            var dialog = the.dialog;
            var options = the.options;
//            var theH = attribute.height(dialog);

            if (!the.hasOpen) {
                return the;
            }

            the.hasOpen = !1;
            openDialogs.pop();

            if (!openDialogs.length) {
                attribute.removeClass(body, overflowClass);
            }

            animation.animate(dialog, {
                opacity: 0,
                transform: 'scale(0)'
            }, {
                duration: options.duration,
                easing: options.easing
            });

            animation.animate(bg, {
                opacity: 0
            }, {
                duration: options.duration,
                easing: options.easing
            }, function () {
                attribute.css(bg, 'display', 'none');
                attribute.css(dialog, 'transform', 'scale(1)');
                options.onclose.call(dialog);

                if (data.type(callback) === 'function') {
                    callback.call(the);
                }
            });

            return the;
        },


        /**
         * 重新定位对话框
         * @param {Function} [callback] 打开之后回调
         * @returns {Dialog}
         */
        position: function (callback) {
            var the = this;
            var options = the.options;
            var pos = the._position();

            animation.animate(the.dialog, pos, {
                duration: options.duration,
                easing: options.easing
            }, function () {
                if (data.type(callback) === 'function') {
                    callback.call(the);
                }
            });

            return the;
        },


        /**
         * 对话框添加内容，并重新定位
         * @returns {Dialog}
         */
        setContent: function (content) {
            var the = this;
            var contentType = data.type(content);

            the.ele.innerHTML = '';

            if (contentType === 'string') {
                content = modification.create('#text', content);
            }

            modification.insert(content, the.ele, 'beforeend');
            the.position();

            return the;
        },


        /**
         * 对话框添加远程地址，并重新定位
         * @param {String} url 远程地址
         * @param {Number} [height=400] 高度
         * @returns {Dialog}
         */
        setRemote: function (url, height) {

            var the = this;
            var options = the.options;
            var iframe = modification.create('iframe', {
                src: url,
                'class': iframeClass,
                style: {
                    height: height || options.remoteHeight
                }
            });

            the.ele.innerHTML = '';
            modification.insert(iframe, the.ele, 'beforeend');
            the.position();

            return the;
        },


        /**
         * 晃动对话框以示提醒
         * @returns {Dialog}
         */
        shake: function () {
            var the = this;

            if (the.shakeTimeid) {
                the.shakeTimeid = 0
                clearTimeout(the.shakeTimeid);
                attribute.removeClass(the.dialog, shakeClass);
            }

            attribute.addClass(the.dialog, shakeClass);

            the.shakeTimeid = setTimeout(function () {
                attribute.removeClass(the.dialog, shakeClass);
            }, 500);

            return the;
        },


        /**
         * 销毁对话框
         * @param {Function} [callback] 打开之后回调
         */
        destroy: function (callback) {
            var the = this;

            // 关闭对话框
            the.close(function () {
                // 从对话框 map 里删除
                delete(dialogsMap[the.id]);

                // 将内容放到 body 里
                modification.insert(the.ele, body, 'beforeend');

                // 移除事件监听
                event.un(the.dialog, 'click tap');
                event.un(the.bg, 'click tap');

                // 在 DOM 里删除
                modification.remove(the.bg);

                if (data.type(callback) === 'function') {
                    callback.call(the);
                }
            });
        },


        /**
         * 获取对话框需要定位的终点位置
         * @returns {Object}
         * @type {{width:Number,height:Number,left:Number,top:Number}}
         * @private
         */
        _position: function () {
            var the = this;
            var options = the.options;
            var winW = attribute.width(window);
            var winH = attribute.height(window);
            var pos = {};

            animation.stop(the.dialog, !0);

            attribute.css(the.dialog, {
                width: options.width,
                height: options.height
            });

            pos.width = attribute.width(the.dialog);
            pos.height = attribute.height(the.dialog);

            if (options.left === 'center') {
                pos.left = (winW - pos.width) / 2;
                pos.left = pos.left &lt; 0 ? 0 : pos.left;
            } else {
                pos.left = options.left;
            }

            if (options.top === 'center') {
                pos.top = (winH - pos.height) * 2 / 5;
                pos.top = pos.top &lt; 0 ? 0 : pos.top;
            } else {
                pos.top = options.top;
            }

            return pos;
        }
    });


    event.on(document, 'keyup', function (eve) {
        var d;

        if (eve.which === 27 &amp;&amp; openDialogs.length) {
            d = dialogsMap[openDialogs[openDialogs.length - 1]];

            if (d &amp;&amp; d.constructor === Dialog) {
                d.shake();
            }
        }
    });

    /**
     * 实例化一个模态交互对话框
     *
     * @param ele {HTMLElement|Node} 元素
     * @param [options] {Object}
     * @param [options.width=500] {Number|String} 对话框宽度
     * @param [options.height="auto"] {Number|String} 对话框高度
     * @param [options.left="center"] {Number|String} 对话框左距离，默认水平居中
     * @param [options.top="center"] {Number|String} 对话框上距离，默认垂直居中（为了美观，表现为2/5处）
     * @param [options.title="无标题对话框"] {String|null} 对话框标题，为null时将隐藏标题栏
     * @param [options.canDrag=true] {Boolean} 对话框是否可以被拖拽，当有标题栏存在的时候
     * @param [options.duration=345] {Number} 对话框打开、关闭的动画时间，单位毫秒
     * @param [options.easing="ease-in-out-back"] {String} 对话框打开、关闭的动画缓冲函数
     * @param [options.remote=null] {null|String} 对话框打开远程地址，优先级2
     * @param [options.remoteHeight=400] {Number} 对话框打开远程地址的高度，单位像素
     * @param [options.content=null] {null|HTMLElement|Node|String} 设置对话框的内容，优先级1
     * @param [options.isWrap=true] {Boolean} 是否自动包裹对话框来，默认 true，优先级1
     * @param [options.onopen] {Function} 对话框打开时回调
     * @param [options.onclose] {Function} 对话框关闭时回调
     * @returns {Dialog}
     *
     * @example
     * var d1 = dialog(ele, options);
     */
    module.exports = function (ele, options) {
        options = data.extend(!0, {}, defaults, options);

        return (new Dialog(ele, options))._init();
    };
});</code></pre>






	            </div>
	        </section>
	    </div>

    


</div>


<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
<script src="js/bootstrap.js"> </script>
<script src="js/script.js"> </script>

</body>
</html>
